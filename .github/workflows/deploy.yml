# GitHub Pages Deployment - All actions pinned to exact SHAs
name: Deploy to GitHub Pages

on:
  push:
    branches: [main, master]
  workflow_dispatch:

# Allow only one concurrent deployment
concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  detect-and-build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      has_dist: ${{ steps.build.outputs.has_dist }}
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      
      # Detect project type and build
      - name: Setup and Build
        id: build
        run: |
          HAS_DIST="false"
          
          # Node.js / Vite / React
          if [ -f "package.json" ]; then
            echo "üì¶ Node.js project detected"
            
            # Setup pnpm
            corepack enable
            corepack prepare pnpm@latest --activate
            
            pnpm install --no-frozen-lockfile
            
            if grep -q '"build"' package.json; then
              VITE_BASE_URL="/${{ github.event.repository.name }}/" pnpm build
            fi
            
            if [ -d "dist" ]; then
              HAS_DIST="true"
            elif [ -d "build" ]; then
              mv build dist
              HAS_DIST="true"
            elif [ -d "out" ]; then
              mv out dist
              HAS_DIST="true"
            fi
          fi
          
          # Python / Sphinx
          if [ -f "pyproject.toml" ] || [ -f "setup.py" ]; then
            echo "üêç Python project detected"
            if [ -d "docs" ] && [ -f "docs/conf.py" ]; then
              pip install sphinx sphinx-rtd-theme
              pip install -e . 2>/dev/null || true
              cd docs && make html && cd ..
              if [ -d "docs/_build/html" ]; then
                mv docs/_build/html dist
                HAS_DIST="true"
              fi
            fi
          fi
          
          # Rust / mdBook
          if [ -f "Cargo.toml" ]; then
            echo "ü¶Ä Rust project detected"
            if [ -f "book.toml" ]; then
              cargo install mdbook 2>/dev/null || true
              mdbook build
              if [ -d "book" ]; then
                mv book dist
                HAS_DIST="true"
              fi
            fi
          fi
          
          # Static site (already has index.html)
          if [ "$HAS_DIST" = "false" ] && [ -f "index.html" ]; then
            echo "üìÑ Static site detected"
            mkdir dist
            cp -r *.html *.css *.js assets/ images/ dist/ 2>/dev/null || true
            HAS_DIST="true"
          fi
          
          echo "has_dist=$HAS_DIST" >> $GITHUB_OUTPUT
          
          if [ "$HAS_DIST" = "true" ]; then
            echo "‚úÖ Build output ready in dist/"
            ls -la dist/
          else
            echo "‚ö†Ô∏è No deployable content found"
          fi

      - uses: actions/configure-pages@983d7736d9b0ae728b81ab479565c72886d7745b # v5.0.0
        if: steps.build.outputs.has_dist == 'true'

      - uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa # v3.0.1
        if: steps.build.outputs.has_dist == 'true'
        with:
          path: ./dist

  deploy:
    name: Deploy
    needs: detect-and-build
    if: needs.detect-and-build.outputs.has_dist == 'true'
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
        id: deployment
