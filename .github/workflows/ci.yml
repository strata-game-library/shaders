# CI Workflow - All actions pinned to exact SHAs
# Security best practice: prevents supply chain attacks
# Cost optimized: efficient caching and parallel execution

name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: read

jobs:
  detect-stack:
    name: Detect Stack
    runs-on: ubuntu-latest
    outputs:
      has_rust: ${{ steps.detect.outputs.has_rust }}
      has_node: ${{ steps.detect.outputs.has_node }}
      has_python: ${{ steps.detect.outputs.has_python }}
      has_python_uv: ${{ steps.detect.outputs.has_python_uv }}
      has_go: ${{ steps.detect.outputs.has_go }}
      has_docs: ${{ steps.detect.outputs.has_docs }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          sparse-checkout: |
            Cargo.toml
            package.json
            pyproject.toml
            setup.py
            requirements.txt
            uv.lock
            go.mod
            docs
          sparse-checkout-cone-mode: false
      - name: Detect project type
        id: detect
        run: |
          echo "has_rust=$([[ -f Cargo.toml ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has_node=$([[ -f package.json ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has_python=$([[ -f pyproject.toml || -f setup.py || -f requirements.txt ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has_python_uv=$([[ -f uv.lock ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has_go=$([[ -f go.mod ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has_docs=$([[ -d docs ]] && echo true || echo false)" >> $GITHUB_OUTPUT

  rust:
    name: Rust
    needs: detect-stack
    if: needs.detect-stack.outputs.has_rust == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          toolchain: stable
          components: clippy, rustfmt
      - uses: swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.7.8
      - run: cargo build --release
      - run: cargo test
      - run: cargo clippy -- -D warnings
      - run: cargo fmt -- --check

  node:
    name: Node.js
    needs: detect-stack
    if: needs.detect-stack.outputs.has_node == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0
        with:
          version: 9
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '22'
          cache: pnpm
      - run: pnpm install --no-frozen-lockfile
      - run: pnpm run lint || true
      - run: pnpm run build || true
      - run: pnpm test || true

  python-uv:
    name: Python (uv)
    needs: detect-stack
    if: needs.detect-stack.outputs.has_python_uv == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86 # v5
        with:
          enable-cache: true
      - run: uv sync --all-extras --dev
      - run: uv run ruff check . || true
      - run: uv run ruff format --check . || true
      - run: uv run pytest || true

  python-pip:
    name: Python (pip)
    needs: detect-stack
    if: needs.detect-stack.outputs.has_python == 'true' && needs.detect-stack.outputs.has_python_uv != 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install
        run: |
          pip install ruff pytest
          if [[ -f requirements.txt ]]; then pip install -r requirements.txt; fi
          if [[ -f pyproject.toml ]]; then pip install -e ".[dev]" 2>/dev/null || pip install -e . 2>/dev/null || true; fi
      - run: ruff check . || true
      - run: pytest || true

  go:
    name: Go
    needs: detect-stack
    if: needs.detect-stack.outputs.has_go == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
        with:
          go-version: '1.22'
      - run: go build -v ./...
      - run: go test -v ./...

  docs-build:
    name: Build & Sync Docs
    needs: detect-stack
    if: needs.detect-stack.outputs.has_docs == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0
        with:
          version: 9
      - uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86 # v5
        with:
          enable-cache: true
      
      - name: Build Docs
        run: |
          if [ -f docs/Makefile ]; then
            cd docs && make html
          elif [ -f package.json ] && grep -q "build:docs" package.json; then
            pnpm install --no-frozen-lockfile
            pnpm run build:docs
          elif [ -f uv.lock ]; then
            uv sync
            uv run sphinx-build -b html docs docs/_build/html 2>/dev/null || true
          elif [ -f Cargo.toml ]; then
            cargo doc --no-deps
          fi
