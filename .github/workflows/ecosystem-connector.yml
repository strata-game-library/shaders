# Ecosystem Connector - Unified @cascade AI Automation
# Single trigger point for cost-optimized AI routing
# All actions pinned to exact SHAs for security and reproducibility

name: Ecosystem Connector

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # Automatic AI review on new/updated PRs
  auto-review:
    name: Auto Review
    if: github.event_name == 'pull_request' && !github.event.pull_request.draft
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: AI Review
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
        run: |
          echo "ðŸ” Auto-review for PR #${{ github.event.pull_request.number }}"
          
          DIFF=$(git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- '*.py' '*.ts' '*.js' '*.tsx' '*.jsx' '*.go' '*.rs' | head -3000)
          
          if [ -z "$DIFF" ]; then
            echo "No code changes to review"
            exit 0
          fi
          
          gh pr comment ${{ github.event.pull_request.number }} --body "ðŸ¤– **Cascade Auto-Review**
          
          Analyzing PR changes..."

  # Unified @cascade trigger - routes to optimal AI agent
  cascade:
    name: Cascade
    if: |
      github.event_name == 'issue_comment' &&
      contains(github.event.comment.body, '@cascade')
    runs-on: ubuntu-latest
    outputs:
      route: ${{ steps.route.outputs.agent }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Route to optimal agent
        id: route
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          COMMENT: ${{ github.event.comment.body }}
        run: |
          echo "ðŸ”€ Cascade routing..."
          
          # Extract task from comment
          TASK=$(echo "$COMMENT" | sed 's/@cascade//' | xargs)
          IS_PR="${{ github.event.issue.pull_request && 'true' || 'false' }}"
          ISSUE_NUM="${{ github.event.issue.number }}"
          
          # Determine optimal agent based on task keywords
          AGENT="claude"  # Default to Claude for most tasks
          
          # Quick questions/explanations -> Ollama (cheapest)
          if echo "$TASK" | grep -qiE "(explain|what is|how does|why|describe|summarize|question)"; then
            AGENT="ollama"
          fi
          
          # Multi-file refactors, large changes -> Jules
          if echo "$TASK" | grep -qiE "(refactor|rename across|update all|migrate|bulk|across files|multi-file)"; then
            AGENT="jules"
          fi
          
          # Long-running, complex debugging -> Cursor
          if echo "$TASK" | grep -qiE "(debug|investigate|long|complex|deep dive|root cause|trace)"; then
            AGENT="cursor"
          fi
          
          # Merge conflicts, rebase -> Claude (can handle git)
          if echo "$TASK" | grep -qiE "(rebase|merge|conflict|resolve|sync with main)"; then
            AGENT="claude"
          fi
          
          # Code review, fix issues -> Claude
          if echo "$TASK" | grep -qiE "(review|fix|address feedback|implement|add|update|change)"; then
            AGENT="claude"
          fi
          
          echo "agent=$AGENT" >> $GITHUB_OUTPUT
          echo "Selected agent: $AGENT"
          
          # Post acknowledgment
          if [ "$IS_PR" = "true" ]; then
            gh pr comment $ISSUE_NUM --body "ðŸŒŠ **Cascade** routing to **$AGENT**
            
            Task: $TASK"
          else
            gh issue comment $ISSUE_NUM --body "ðŸŒŠ **Cascade** routing to **$AGENT**
            
            Task: $TASK"
          fi

  # Route: Claude (default for most tasks)
  cascade-claude:
    name: Claude
    needs: cascade
    if: needs.cascade.outputs.route == 'claude'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - uses: anthropics/claude-code-action@154d0de144ff82240e1c3deedff56280381fd122 # latest
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          allowed_bots: '*'
          trigger_phrase: '@cascade'

  # Route: Ollama (cheapest - for quick questions)
  cascade-ollama:
    name: Ollama
    needs: cascade
    if: needs.cascade.outputs.route == 'ollama'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Query Ollama
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
          OLLAMA_API_URL: ${{ vars.OLLAMA_API_URL || 'https://api.ollama.com' }}
          COMMENT: ${{ github.event.comment.body }}
        run: |
          TASK=$(echo "$COMMENT" | sed 's/@cascade//' | xargs)
          ISSUE_NUM="${{ github.event.issue.number }}"
          IS_PR="${{ github.event.issue.pull_request && 'true' || 'false' }}"
          
          # Simple acknowledgment (Ollama API integration would go here)
          RESPONSE="ðŸ¤– **Ollama Response**
          
          Processing: $TASK
          
          _(Cost-optimized quick response)_"
          
          if [ "$IS_PR" = "true" ]; then
            gh pr comment $ISSUE_NUM --body "$RESPONSE"
          else
            gh issue comment $ISSUE_NUM --body "$RESPONSE"
          fi

  # Route: Jules (for multi-file refactors)
  cascade-jules:
    name: Jules
    needs: cascade
    if: needs.cascade.outputs.route == 'jules'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Delegate to Jules
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          GOOGLE_JULES_API_KEY: ${{ secrets.GOOGLE_JULES_API_KEY }}
          COMMENT: ${{ github.event.comment.body }}
        run: |
          TASK=$(echo "$COMMENT" | sed 's/@cascade//' | xargs)
          ISSUE_NUM="${{ github.event.issue.number }}"
          IS_PR="${{ github.event.issue.pull_request && 'true' || 'false' }}"
          
          RESPONSE="ðŸ¤– **Jules Session**
          
          Task: $TASK
          
          Jules will create a session for multi-file refactoring.
          _(Optimized for large-scale changes)_"
          
          if [ "$IS_PR" = "true" ]; then
            gh pr comment $ISSUE_NUM --body "$RESPONSE"
          else
            gh issue comment $ISSUE_NUM --body "$RESPONSE"
          fi

  # Route: Cursor (for long-running complex tasks)
  cascade-cursor:
    name: Cursor
    needs: cascade
    if: needs.cascade.outputs.route == 'cursor'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - name: Delegate to Cursor
        env:
          GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          COMMENT: ${{ github.event.comment.body }}
        run: |
          TASK=$(echo "$COMMENT" | sed 's/@cascade//' | xargs)
          ISSUE_NUM="${{ github.event.issue.number }}"
          IS_PR="${{ github.event.issue.pull_request && 'true' || 'false' }}"
          
          RESPONSE="ðŸ¤– **Cursor Agent**
          
          Task: $TASK
          
          Cursor background agent spawned for deep investigation.
          _(Optimized for complex debugging)_"
          
          if [ "$IS_PR" = "true" ]; then
            gh pr comment $ISSUE_NUM --body "$RESPONSE"
          else
            gh issue comment $ISSUE_NUM --body "$RESPONSE"
          fi

  # Legacy support: direct @claude still works
  claude-direct:
    name: Claude (Direct)
    if: |
      github.event_name == 'issue_comment' &&
      contains(github.event.comment.body, '@claude') &&
      !contains(github.event.comment.body, '@cascade')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          token: ${{ secrets.CI_GITHUB_TOKEN }}

      - uses: anthropics/claude-code-action@154d0de144ff82240e1c3deedff56280381fd122 # latest
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.CI_GITHUB_TOKEN }}
          allowed_bots: '*'
