name: Autoheal
# Consolidated CI failure resolution workflow
# Replaces: ai-fixer, ecosystem-fixer, ecosystem-fixer-local
#
# INTELLIGENT CONFLICT RESOLUTION:
# - Automatically resolves CI failures
# - Resolves merge conflicts triggered by triage workflow
# - Uses AI to analyze and fix issues

on:
  workflow_run:
    workflows: ["CI", "Go"]
    types: [completed]
  workflow_call:
    inputs:
      operation:
        description: 'Operation type (analyze_failure, resolve_conflicts)'
        required: false
        type: string
        default: 'analyze_failure'
      run_id:
        description: 'Workflow run ID to fix'
        required: false
        type: string
      pr_number:
        description: 'PR number (for conflict resolution)'
        required: false
        type: string
      repository:
        description: 'Repository (owner/repo)'
        required: true
        type: string
  workflow_dispatch:
    inputs:
      operation:
        description: 'Operation to perform'
        required: true
        type: choice
        options:
          - analyze_failure
          - resolve_conflicts
          - apply_fix
      run_id:
        description: 'Workflow run ID to fix (for failures)'
        required: false
        type: string
      pr_number:
        description: 'PR number (for conflicts)'
        required: false
        type: string
      repository:
        description: 'Repository (owner/repo)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  # ============================================
  # CI FAILURE RESOLUTION
  # ============================================
  quick-fix:
    runs-on: ubuntu-latest
    if: |
      (github.event.workflow_run.conclusion == 'failure') ||
      (github.event_name == 'workflow_call' && inputs.operation == 'analyze_failure') ||
      (github.event_name == 'workflow_dispatch' && inputs.operation == 'analyze_failure')
    steps:
      - name: Analyze failure with control-center
        id: analyze
        run: |
          RUN_ID="${{ inputs.run_id || github.event.workflow_run.id }}"
          REPO="${{ inputs.repository || github.repository }}"
          
          docker run --rm \
            -e GITHUB_TOKEN="${GITHUB_TOKEN}" \
            -e OLLAMA_API_KEY="${OLLAMA_API_KEY}" \
            jbcom/control-center:latest fixer analyze \
            --run-id "$RUN_ID" \
            --repo "$REPO" \
            --output json > fix-suggestion.json
          
          echo "suggestion<<EOF" >> $GITHUB_OUTPUT
          cat fix-suggestion.json >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}

      - name: Apply quick fix
        if: steps.analyze.outputs.suggestion != ''
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            -e GITHUB_TOKEN="${GITHUB_TOKEN}" \
            jbcom/control-center:latest fixer apply \
            --suggestion-file fix-suggestion.json \
            --repo ${{ inputs.repository || github.repository }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment fix on PR
        if: github.event.workflow_run.pull_requests[0]
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const fs = require('fs');
            const suggestion = JSON.parse(fs.readFileSync('fix-suggestion.json', 'utf8'));
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.workflow_run.pull_requests[0].number,
              body: `## ðŸ”§ CI Fix Suggestion\n\n${suggestion.description}\n\n---\n<sub>ðŸ¤– Generated by Control Center Autoheal</sub>`
            });

  # ============================================
  # MERGE CONFLICT RESOLUTION
  # ============================================
  resolve-conflicts:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_call' && inputs.operation == 'resolve_conflicts') ||
      (github.event_name == 'workflow_dispatch' && inputs.operation == 'resolve_conflicts')
    steps:
      - name: Post conflict resolution guidance
        run: |
          PR_NUM="${{ inputs.pr_number }}"
          REPO="${{ inputs.repository || github.repository }}"
          
          docker run --rm \
            -e GITHUB_TOKEN="${GITHUB_TOKEN}" \
            jbcom/control-center:latest fixer resolve-conflict \
            --repo "$REPO" \
            --pr "$PR_NUM"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
